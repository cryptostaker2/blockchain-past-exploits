 ## FAPEN Token Exploit, 29 May 2023 - Wrong check in unstake() function

 ### Summary 
 
 - The attacker found a flaw in the `unstake()` function in the FAPEN token contract. This flaw allowed him to withdraw all the tokens in the FAPEN contract, which was about 9,521,992 tokens (note that FAPEN has [9 decimals](https://bscscan.com/address/0xf3f1abae8bfeca054b330c379794a7bf84988228#readContract))
 - The attacker then swapped all the FAPEN tokens for WBNB using Pancakeswap FAPEN-WBNB pair via the swapTokensForETH route
 - The WBNB tokens that were swapped to were exchanged for BNB tokens
 - Total loss: **2.04 WBNB (~600 USD)**

 ### Test command

 > forge test --contracts ./bsc/test/fapen/fapen.t.sol -vv

 Test should pass and console should show this:

 ![FapenTest](images/fapentest.png)
 
 ### Proof of Concept

 [fapen.t.sol](https://github.com/cryptostaker2/blockchain-past-exploits/blob/main/bsc/test/fapen/fapen.t.sol)

 ### Transaction References

 1. [Attack Transaction](https://bscscan.com/tx/0xa2be65e439eb182e8f2acfe7eff9a4bab55eb3cd789dcc0ddd19bf811af78a93)
 2. [FAPEN Contract](https://bscscan.com/address/0xf3f1abae8bfeca054b330c379794a7bf84988228)
 3. [Phalcon Explorer](https://explorer.phalcon.xyz/tx/bsc/0xa2be65e439eb182e8f2acfe7eff9a4bab55eb3cd789dcc0ddd19bf811af78a93)

### In-depth Explanation

The check in the `unstake()` function is written incorrectly. The attacker can set any amount and increase his balance. The correct check should be `require(balances[msg.sender] >= amount, "Not enough staked balance to unstake");` 

![Fapen](images/fapen.png)

### Difficulty Level

- Complexity of Attack: Easy
- Level of Understanding Required: Low

The attack is just a simple logic flaw in the FAPEN token contract. Once the attacker withdrew all the FAPEN tokens in the FAPEN contract, the attacker swaps the FAPEN tokens for WBNB using Pancakeswap WBNB-FAPEN pair.

