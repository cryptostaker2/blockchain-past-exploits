 ## Shido Protocol Exploit (BSC), 24 June 2023 - V1 to V2 Migration Attack

 ### Summary 

 - Attacker flashloaned 40 BNB from DODO Oracle
 - Attacker swapped 39 BNB for 10 billion SHIDO, **the receiver is AddRemoveLiquidityForFeeOnTransferTokens contract**
(It is unclear how the receiver gets 10 billion SHIDO by swapping 39 BNB, but when any other contracts swap 39 BNB to shido, they get 10 million SHIDO instead)
 - The attacker converts 0.01 WBNB to 0.01 BNB 
 - The attacker swaps 0.1 BNB and receives ~14m SHIDO
 - The attacker sets up a new liquidity pool and deposits 0.01 BNB and 1m SHIDO 
 (The purpose of creating an LP is to withdraw the 10 billion SHIDO from the AddRemoveLiquidityForFeeOnTransferTokens contract)
 - The attacker calls `lockTokens()` and `claimTokens()` in the ShidoLock contract. This swaps the V1 Shido to the V2 Shido tokens at a 1:1 exchange rate
 - The attacker swaps 10 billion SHIDOV2 and receives 1,0169 BNB
 - The attacker repays the 40 BNB flashloan and pockets ~997 BNB
- Total loss: **997 BNB (~238k USD)**

### Test command

 > forge test --contracts ./bsc/test/shido/shido.t.sol -vv
 
 ### Proof of Concept

 [shido.t.sol](https://github.com/cryptostaker2/blockchain-past-exploits/blob/main/bsc/test/shido/shido.t.sol)

 ### Transaction References
 1. [Attack Transaction](https://bscscan.com/tx/0x72f8dd2bcfe2c9fbf0d933678170417802ac8a0d8995ff9a56bfbabe3aa712d6)
 2. [Shido V1 Contract](https://bscscan.com/address/0x733af324146dcfe743515d8d77dc25140a07f9e0)
 3. [Shido V2 Contract](https://bscscan.com/address/0xa963ee460cf4b474c35ded8fff91c4ec011fb640)
 4. [AddRemoveLiquidityForFeeOnTransferTokens Contract](https://bscscan.com/address/0x9869674e80d632f93c338bd398408273d20a6c8e)
 5. [Shido Lock Contract](https://bscscan.com/address/0xaf0ca21363219c8f3d8050e7b61bb5f04e02f8d4)
 6. [Attacker](https://bscscan.com/address/0x69810917928b80636178b1bb011c746efe61770d)
 7. [Attack Contract](https://bscscan.com/address/0xcdb3d057ca0cfdf630baf3f90e9045ddeb9ea4cc)
 8. [Phalcon Explorer](https://explorer.phalcon.xyz/tx/bsc/0x72f8dd2bcfe2c9fbf0d933678170417802ac8a0d8995ff9a56bfbabe3aa712d6)

### In-depth Explanation

##### Shido-WBNB Liquidity Pool Before 40WBNB swap 
- ShidoPair Balance of Shido: 21978525030516602360
- ShidoPair Balance of Shido: 11541552344840211663 (after first swap, -10B shido)

##### Shido-WBNB Liquidity Pool After 40WBNB swap 
- ShidoPair Balance of WBNB: 43019681436106797846
- ShidoPair Balance of WBNB: 82019681436106797846 (after first swap, +39 BNB)

##### Total Shido in AddRemoveLiquidityForFeeOnTransferTokens Contract
- 10,436,972,685,676,390,697 SHIDO
- 10,436,972,685 SHIDO (9 decimals)

##### If receiver is attack contract, 
10,436,972,685,676,392 SHIDO in attacker contract instead (Why? This part is not explained, trying to figure out)

##### ShidoV2-WBNB Liquidity Pool before
- ShidoV2Pair Balance of Shido: 1638814202042634346612419124
- ShidoV2Pair Balance of Shido: 11032102236662779294012419124 (end)

##### ShidoV2-WBNB Liquidity Pool after
- ShidoV2Pair Balance of WBNB: 1193802448178091070023
- ShidoV2Pair Balance of WBNB: 177717150858036006194