 ## CNN Token Exploit, 25 May 2023 - Logic Flaw in buy() function 

 ### Summary 
 
 - NOTE: The Actual Exploited Contract is Unknown. The exploit is obtained through evidence from the transaction history
 - The attacker flashloaned 15,000 BUSDT from DODO Oracle
 - The attacker swaps 15,000 BUSDT for ~660,859 CNN tokens
 - The attacker calls the `buy()` function of an unknown contract. This function swaps 5600 BUSDT for ~7,070 CNN tokens
 - The attacker swapped back all his CNN tokens for 20,573 BUSDT 
 - The attacker repays the 15,000 flashloan and keeps 5,573 BUSDT
 - Total loss: **~5,575 BUSDT**

  ### Test command

 > forge test --contracts ./bsc/test/cnn/cnn.t.sol -vv

 Test should pass and console should show this:

 ![CNNTest](images/cnntest.png)

  ### Proof of Concept

 [cnn.t.sol](https://github.com/cryptostaker2/blockchain-past-exploits/blob/main/bsc/test/cnn/cnn.t.sol)

 ### Transaction References

 1. [Attack Transaction](https://bscscan.com/tx/0xd3bfd56c1f501d449199a4739f213631419dc6630e28355ce58196791eed63fc)
 2. [Phalcon Explorer](https://explorer.phalcon.xyz/tx/bsc/0xd3bfd56c1f501d449199a4739f213631419dc6630e28355ce58196791eed63fc)
 3. [Unknown Compromised Contract](https://bscscan.com/address/0x5a3243da39ffd745621c5a48ffd60642db2c127a)
 4. [CNN Pair Contract](https://bscscan.com/address/0x4d442da9bf6ed73d19d6b1b163c9d57d539f52ac)

### In-depth Explanation

CNNPair BUSDT Balance before exploit: 605.705609617735474807
<br>
CNNPair CNN Balance before exploit: 701717.349323015036809133
<br>
CNNPair BUSDT Balance after swap: 15605.705609617735474807 (Swap 15000 BUSDT, which was obtained through flashloan)
<br>
CNNPair CNN Balance after swap: 27370.712839524733172846
<br>
CNNPair BUSDT Balance after buy: 21205.705609617735474807 (Somehow, 5600 BUSDT was swapped to CNN when calling `buy()`)
<br>
CNNPair CNN Balance after buy: 20155.965487985665550142
<br>
CNNPair BUSD Balance at end: 631.739164181394514776 (Withdraw 15000 BUSDT back and obtained extra CNN)
<br>
CNNPair CNN Balance at end: 681015.669241806163113704

Additional Notes:

- Seems like the `buy()` function can only be called once.
- Seems like the `buy()` function swaps exactly 5600 BUSDT with CNN (there is no input parameter) 

### Difficulty Level

- Complexity of Attack: Unknown
- Level of Understanding Required: Low

The code for the compromised `buy()` function is not published, so it is unclear how complex the function was. From the transaction logs, the contract seems like it is simply a one-time-call function that swaps 5600 BUSDT to CNN through the BUSDT-CNN CNNPair. The rest of the exploit is just using the swap function from their own CNN Router (similar to pancakeswap router)

