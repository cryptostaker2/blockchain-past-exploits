 ## LUSD Protocol Exploit, 07 July 2023 - Internal Oracle Price Manipulation

 ### Summary 

- Attacker gets a ~3.5m BUSD flashloan from 5 different oracles
- Attacker calls a flashswap on the BUSD-BTCB pair and withdraws 1.2 BTC
- Attacker transfers 800,000 BUSD to the pair through the `pancakeCall()` callback function
- Originally, one BTC was worth ~30k. After the transfer, 1 BTC is worth ~11m
- Attacker calls `supply()` on the Loan contract and mints 10,000 LUSD with 0.0015 BTC. This works because the `supply()` function checks the price of BTCB in terms of BUSD. Since the price was manipulated in the first swap, 1 BTC is worth a lot now
- Attacker calls `withdraw()` on the LUSDPool contract. 1 LUSD is pegged to 1 BUSD, so the attacker manages to withdraw 10,000 BUSD. The reason why the attacker only can withdraw 10,000 BUSD is because the LUSDPool contract only have 10,000 BUSD inside at the moment of the attack
- Attacker transfers 1.2 BTC back to the BUSD-BTCB pair
- Attacker calls a flashswap again, this time without a callback on the BUSD-BTCB pair and withdraws 799,794 BUSD
- Attacker repays the 3.5m flashloan and profitted ~9.5k BUSD.
- Total loss: **~9.5k BUSD**

### Test command

 > forge test --contracts ./bsc/test/lusd/lusd.t.sol -vv
 
 ### Proof of Concept

 [lusd.t.sol](https://github.com/cryptostaker2/blockchain-past-exploits/blob/main/bsc/test/lusd/lusd.t.sol)

 ### Transaction References

 1. [Attack Transaction](https://bscscan.com/tx/0x1eeef7b9a12b13f82ba04a7951c163eb566aa048050d6e9318b725d7bcec6bfa)
 2. [Loan Contract](https://bscscan.com/address/0xdec12a1dcbc1f741ccd02dfd862ab226f6383003)
 3. [LUSDPool Contract](https://bscscan.com/address/0x637de69f45f3b66d5389f305088a38109aa0cf7c)
 4. [Attacker](https://bscscan.com/address/0x21ad028c185ac004474c21ec5666189885f9e518)
 5. [Phalcon Explorer](https://explorer.phalcon.xyz/tx/bsc/0x1eeef7b9a12b13f82ba04a7951c163eb566aa048050d6e9318b725d7bcec6bfa)

### In-depth Explanation

- The original BUSD-BTCB pool has 39K BUSD and 1.308 BTC 
- The attacker calls for a flashswap and withdraws 1.246 BTC. The flashswap then calls the `pancakeCall()` callback function, and the attacker deposits 800,000 BUSD inside. This may be pretty weird because 1.246 BTC is not worth 800,000 BUSD. The reason why so much BUSD was transferred inside is so that the new K constant is greater than the old K constant. When flashswapping, the user can choose to deposit back the amount withdrawn or the other token, as long as the new K value remains the same or is greater than the old K value
- After the first swap, BUSD-BTCB pool has 839k BUSD and 0.06194506649 BTCB
- Originally, one BTC was worth ~30k. After the transfer, 1 BTC is worth >10m
- Attacker only supplied a small sum of 0.0015 BTCB (~$45 if BTC is worth $30,000) and got 10,000 LUSD. If you look at the [Loan Contract](https://bscscan.com/address/0xdec12a1dcbc1f741ccd02dfd862ab226f6383003), you will notice that it has 0.00153327 BTC inside 